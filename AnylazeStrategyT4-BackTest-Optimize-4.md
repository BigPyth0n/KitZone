# StrategyT4 BackTest & Optimization

## 📖 معرفی پروژه

**StrategyT4-BackTest-Optimize-4.py** یک اسکریپت پایتونی است برای:

* شبیه‌سازی (بک‌تست) و بهینه‌سازی استراتژی‌های معاملاتی در بازار فیوچرز (Futures) صرافی‌های Binance و KuCoin.
* ذخیره‌سازی نتایج به‌صورت پایگاه‌داده SQLite، فایل‌های JSON، تصاویر نمودار و گزارش‌های گرافیکی.
* ارائه رابط کاربری تحت وب با استفاده از Streamlit برای تنظیم پارامترها و نمایش نتایج.

**هدف** این پروژه کمک به معامله‌گران و تحلیل‌گران است تا استراتژی‌های خود را با داده‌های واقعی شبیه‌سازی، ارزیابی و بهینه کنند، بدون نیاز به دانش عمیق برنامه‌نویسی.

---

## 🧠 توضیح استراتژی معاملاتی

1. **منطق اصلی:**

   * شناسایی نقاط پیوت (Pivot) بالا (High) و پایین (Low) در نمودار کندل‌استیک.
   * ترسیم ناحیه FTC (Fair Trading Channel) پس از هر پیوت بر اساس ATR، نسبت قدرت پیوت و عرض کندل.
   * بررسی شرایط تثبیت (Stabilization) و تأیید (Confirmation) در کندل‌های بعدی.
   * ورود به معامله خرید (Buy) یا فروش (Sell) هنگام شکست ناحیه FTC با نسبت ریسک:پاداش (Risk\:Reward) قابل تنظیم.

2. **ورود و خروج:**

   * **ورود (Entry):**

     * اگر قیمت از سقف ناحیه زون عبور کند، معامله خرید باز می‌شود.
     * اگر قیمت از کف ناحیه عبور کند، معامله فروش باز می‌شود.
   * **حد ضرر (SL):** بر اساس ارتفاع ناحیه FTC تنظیم می‌شود.
   * **حد سود (TP):** با توجه به نسبت ریسک‌به‌پاداش (مثلاً 1:1 یا 1:2) مقداردهی می‌شود.
   * **بستن خودکار:** معاملات پس از رسیدن به SL یا TP بسته می‌شوند.

3. **شاخص‌ها و ابزار:**

   * ATR (Average True Range) برای سنجش نوسان و عرض زون.
   * بررسی کندل‌های با نسبت بدنه به بدنه کل (برای حذف کندل‌های ناپایدار).

---

## ⚙️ ورودی‌ها (Inputs)

در سایدبار Streamlit می‌توانید مقادیر زیر را تنظیم کنید:

| پارامتر                 | نوع        | توضیح                                                     |
| ----------------------- | ---------- | --------------------------------------------------------- |
| `lookback_candles`      | عدد صحیح   | تعداد کندل برای شروع بک‌تست (به‌صورت گذشته تا نقطه فعلی). |
| `leverage`              | عدد اعشاری | لوریج معاملاتی (مثلاً 10 برای لوریج 10x).                 |
| `max_open_trades`       | عدد صحیح   | حداکثر تعداد معاملات هم‌زمان باز.                         |
| `initial_balance`       | عدد اعشاری | موجودی اولیه حساب (به ارز پایه).                          |
| `max_drawdown`          | درصد       | بیشترین Drawdown مجاز تا پایان بک‌تست.                    |
| `stabilization_candles` | عدد صحیح   | تعداد کندل برای بررسی تثبیت پس از پیوت.                   |
| `confirmation_candles`  | عدد صحیح   | کندل‌های تأیید بعد از تثبیت.                              |
| `pivot_threshold`       | درصد       | درصد قدرت پیوت برای انتخاب پیوت‌های مهم.                  |
| `atr_period`            | عدد صحیح   | دوره محاسبه ATR (مثلاً 14 کندل).                          |
| `min_zone_width`        | عدد اعشاری | حداقل عرض زون بر حسب ATR.                                 |
| `select_exchange`       | گزینه      | انتخاب صرافی (`binance` یا `kucoin`).                     |

> **نکته:** هر پارامتر یک توضیح کوتاه زیر خود نیز نمایش داده می‌شود تا کاربر متوجه نقش آن باشد.

---

## 📊 خروجی‌ها (Outputs)

1. **پایگاه‌داده SQLite (`backtest.db`):**

   * **جداول:**

     * `BacktestRuns` (مشخصات هر اجرای بک‌تست)
     * `Trades` (اطلاعات هر معامله باز شده)
     * `Settings` (مقادیر پارامترهای ورودی)
     * `RawData` (داده‌های قیمتی اولیه به همراه ATR)

2. **فایل‌های JSON (`results/YYYYMMDD_HHMMSS/`):**

   * شامل آرایه‌ای از معاملات با جزئیات کامل (زمان ورود، خروج، SL، TP، حجم و غیره).

3. **تصاویر معاملات (`images/`):**

   * هر معامله به‌صورت نمودار کندل‌استیک با ناحیه FTC و خطوط SL/TP ذخیره می‌شود.

4. **گزارش تعاملی در Streamlit:**

   * نمودار سود تجمعی (Equity Curve).
   * هیستوگرام سود و زیان معاملات.
   * جدول معاملات با قابلیت فیلتر و مرتب‌سازی.

---

## 🔍 شرح توابع (Functions)

### 1. مدیریت پایگاه‌داده

* **`connect_to_backtest_db(db_file)`**

  * **ورودی:** مسیر فایل SQLite.
  * **خروجی:** شیء اتصال (`conn`).
  * **عملکرد:** اتصال به فایل دیتابیس و بازگرداندن Cursor.

* **`migrate_database(conn)`**

  * **ورودی:** شیء اتصال دیتابیس.
  * **عملکرد:** اضافه کردن ستون `trade_title` به جدول `Trades` در صورت نبودن.

* **`create_backtest_tables(conn)`**

  * **ورودی:** شیء اتصال.
  * **عملکرد:** ایجاد جداول اصلی در دیتابیس.

* **`save_backtest_run(conn, settings)`**, **`save_trade(conn, trade)`**, **`save_raw_data(conn, data)`**, **`export_to_json(results, folder)`**

  * **عملکرد:** ذخیره نتایج و تبدیل به JSON.

### 2. دریافت اطلاعات نمادها

* **`get_futures_symbols(client)`**

  * واکشی لیست نمادهای فعال فیوچرز.

* **`get_symbol_info(client, symbol)`**

  * واکشی پارامترهای معاملاتی هر نماد (پیپ، حداقل حجم و …).

### 3. شناسایی پیوت و ناحیه FTC

* **`is_not_sharp_candle(candle)`**

  * حذف کندل‌های با بدنه بسیار نازک.

* **`find_high_pivots(df, threshold)`** و **`find_low_pivots(df, threshold)`**

  * شناسایی نقاط پیوت بر اساس مقایسه با کندل‌های مجاور.

* **`find_FTC_range(pivot_idx, df, atr_period, ...)`**

  * محاسبه محدوده ناحیه پس از پیوت با استفاده از ATR و پارامترهای فیلتر.

### 4. دریافت داده و محاسبه ATR

* **`fetch_historical_data(client, symbol, timeframe)`**

  * واکشی OHLCV
  * محاسبه ATR با دوره مشخص
  * برگرداندن DataFrame و مدت زمان بک‌تست

### 5. بک‌تست اصلی

* **`backtest_strategy_t3(settings, client, symbols, timeframes)`**

  * هسته اصلی: تکرار کندل‌ها، بررسی شرایط SL/TP، شناسایی پیوت، ترسیم ناحیه، ورود/خروج معاملات، به‌روز‌رسانی Equity.

### 6. تصویرسازی معاملات

* **`save_trade_image(trade, df, folder)`**

  * رسم کندل‌استیک با Plotly
  * هایلایت ناحیه FTC و نقاط ورود/خروج

### 7. تحلیل هوشمند با Avalai

* **`analyze_with_avalai(backtest_results)`**

  * ارسال داده‌ها به مدل LLM
  * دریافت پیشنهادات بهینه‌سازی

---

## 🔄 ساختار اجرای برنامه

1. **بارگذاری کتابخانه‌ها و CSS**
2. **راه‌اندازی Streamlit** و پیکربندی صفحه
3. **اتصال و مهاجرت دیتابیس**
4. **خواندن پارامترها از سایدبار**
5. **انتخاب صرافی و ساخت کلاینت**
6. **واگذاری لیست نمادها و تایم‌فریم‌ها**
7. **فشردن دکمه Run:**

   * واکشی داده‌های تاریخی
   * اجرای تابع بک‌تست
   * ذخیره نتایج (دیتابیس، JSON، تصاویر)
8. **نمایش نتایج در Streamlit:**

   * نمودار سود تجمعی، هیستوگرام، جدول معاملات
   * دکمه دریافت فایل JSON
   * نمایش تحلیل هوشمند (در صورت فعال بودن)

---

## 🚀 راهنمای استفاده برای کاربر نهایی

1. **پیش‌نیازها:**

   * Python 3.8+
   * نصب کتابخانه‌ها: `pip install -r requirements.txt`
   * کلیدهای API Binance/KuCoin
2. **ساختار فایل‌ها:**

   ```
   /StrategyT4-BackTest-Optimize-4.py
   /css/local.css
   /images/
   /results/
   ```
3. **اجرای برنامه:**

   ```bash
   streamlit run StrategyT4-BackTest-Optimize-4.py
   ```
4. **تنظیم پارامترها:**

   * در پنل کناری (سایدبار) مقادیر ورودی را تنظیم کنید.
   * دکمه **Run Backtest** را بزنید.
5. **مشاهده خروجی:**

   * گزارش گرافیکی در صفحه اصلی
   * تصاویر معاملات در پوشه `images/`
   * فایل‌های JSON در `results/YYYYMMDD_HHMMSS/`

---

**موفق باشید!**

> این README به‌گونه‌ای طراحی شده که حتی کاربر بدون پیش‌زمینه فنی نیز بتواند مراحل نصب و اجرا، منطق استراتژی و گزارش نتایج را دنبال کند.
