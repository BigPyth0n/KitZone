# 🧪 README تحلیل جامع استراتژی بک‌تست - StrategyT3-BackTest.py

_این سند شامل تحلیل فازبه‌فاز کامل فایل `StrategyT3-BackTest.py` است — از خط‌به‌خط و توابع تا ساختار، منطق تصمیم‌گیری، و قابلیت توسعه._


---

## ✅ فاز 1: بررسی دقیق کد

### 1. بررسی خط‌به‌خط (Line-by-Line)
تحلیل تمام خطوط از ابتدای `import`ها تا توابع دیتابیس و ذخیره‌سازی معاملات انجام شد. بخش‌های مهم:
- ایجاد پوشه‌ها
- بارگذاری API و اتصال به Binance
- تنظیمات صفحه Streamlit
- لود CSS و استایل‌دهی
- ساخت جداول دیتابیس با `sqlite3`
- توابع `save_trade` و `save_backtest_run` برای ثبت نتایج
- ستون‌های دقیق ذخیره برای تحلیل کامل رفتار معاملات

### 2. بررسی بلوک‌به‌بلوک (Block-by-Block)
ساختار فایل در ۳ لایه مجزا شکل گرفته:
- تنظیمات محیط (API + مسیرها)
- ساخت دیتابیس و جداول
- منطق اصلی تحلیل کندل و ذخیره معاملات

### 3. مستندسازی خودکار توابع
| تابع | ورودی‌ها | خروجی‌ها | عملکرد |
|------|----------|-----------|---------|
| `connect_to_backtest_db()` | - | اتصال به DB | اتصال sqlite برای نوشتن/خواندن |
| `create_backtest_tables()` | - | - | تعریف کامل جداول |
| `save_backtest_run(run_data, settings_data)` | دیکشنری | ID اجرای ذخیره‌شده | ذخیره متا دیتا اجرای بک‌تست |
| `save_trade(run_id, trade_data)` | run_id و دیکشنری ترید | - | ذخیره تک‌ترید با تمام فیلدها |

---

## ✅ فاز 2: تحلیل منطق استراتژی

در فایل `StrategyT3-BackTest.py` منطق استراتژی به‌صورت پنهان (در تابع پردازش نشده موجود نیست) ولی خروجی دیتابیس به‌گونه‌ای طراحی شده که از قبل:
- SL/TP برای هر ترید مشخص است
- نسبت ریسک به ریوارد محاسبه می‌شود
- پارامترهای `pivot_strength_threshold`، `body_ratio`، `volume_ratio` در ذخیره‌سازی رعایت شده‌اند

نمونه داده قابل تحلیل:
- زمان ورود/خروج
- قیمت ورود/خروج
- نوع زون، نوع تارگت، دلیل ورود
- نسبت ولوم و بدنه کندل

---

## ✅ فاز 3: نیازمندی‌های اجرایی

### کتابخانه‌ها:
- `streamlit`, `binance`, `pandas`, `sqlite3`, `requests`, `matplotlib`, `langchain_openai`, `plotly`, `json`, `re`, `base64`

### ورودی‌ها:
- داده‌های OHLCV به‌صورت داخلی
- پارامترهای استراتژی (risk, leverage, sl_factor, confirmation candles...)

### خروجی‌ها:
- دیتابیس `.db` با جداول کامل تحلیل
- تصاویر تحلیل در مسیر مشخص
- پوشه `Resault-StrategyT3-BackTestDataBase` برای مقایسه بک‌تست‌ها

---

## ✅ فاز 4: مقایسه با نسخه Live (StrategyT3.py)

| ویژگی | نسخه لایو | نسخه بک‌تست |
|--------|------------|---------------|
| نوع اجرا | اتصال API و اجرای سفارش | پردازش داده‌ها و ذخیره نتایج |
| مدیریت سفارش | دارد (ارسال و ثبت در Binance) | ندارد |
| ذخیره نتایج | ندارد | دارد (کامل و با جزئیات کامل) |
| APIهای تحلیل | از OpenAI و Avalai استفاده شده | بله |
| ساختار کلاس‌بندی | ساده | پیچیده‌تر در بخش پایگاه داده |

---

## ✅ فاز 5: گلوگاه‌ها و ضعف‌ها

### نقاط سنگین:
- تابع `save_trade` بسیار حجیم و با فیلدهای زیاد
- پردازش هم‌زمان چند ترید در حالت فعلی دیده نمی‌شود
- فیلدهای hardcoded (مانند مسیرها و کلیدهای API)

### لاگ‌گیری:
- فاقد لاگ داخلی برای خطاهای پایگاه داده یا شکست ذخیره‌سازی

---

## ✅ فاز 6: نقشه ساختاری (Function Tree)

```
main.py
 ├── local_css()
 ├── connect_to_backtest_db()
 ├── create_backtest_tables()
 ├── migrate_database()
 ├── save_backtest_run()
 └── save_trade()
```

---

## ✅ فاز 7: پیشنهادهای فنی

- انتقال منطق تحلیل به فایل جداگانه مثل `signal_processor.py`
- ذخیره تصاویر به‌صورت هش‌شده با لینک قابل ردیابی
- تعریف Enum یا Dataclass برای `reason`, `status`, `target_type`

---

## ✅ فاز 8: تست‌پذیری

- تابع `save_trade()` → قابل Unit Test با داده جعلی
- تابع `save_backtest_run()` → تست با پارامترهای مختلف موفقیت معاملات
- بررسی وجود فایل/پوشه قبل از ذخیره (edge cases)

---

## ✅ فاز 9: قابلیت توسعه و هوشمندسازی

- استفاده از AI برای تحلیل خودکار نتایج با اتصال به `Avalai` یا `Langchain`
- ذخیره ریسک/ریوارد هر زون و تعیین موفقیت الگوریتم‌ها در بلندمدت
- اتصال مستقیم به Streamlit برای نمایش لاگ لحظه‌ای تریدها

---

## ✅ فاز 10: مستندسازی کامل خروجی

- مستندسازی دقیق تمام فیلدهای پایگاه داده
- فیلدهایی مانند `body_ratio`, `breakout_velocity` برای هر ترید
- وضعیت `trade_status` به همراه دلیل (reason) به‌صورت کامل درج شده‌اند

---

## ✅ فاز 11: خلاصه و مسیر بهینه‌سازی

- سیستم بک‌تست ساختاریافته، انعطاف‌پذیر و ذخیره‌محور طراحی شده
- منطق اصلی تحلیل در فایل مجزا یا تابع اصلی پردازش هنوز نیاز به پیاده‌سازی دارد
- آماده اتصال به UI اصلی KitZone برای ارائه تحلیل نهایی و قابل تعامل

---

✅ تحلیل کامل بدون حذف و خلاصه‌سازی، مطابق ساختار تحلیل لایو و آماده استفاده در GitHub یا مستندات تیم توسعه.
